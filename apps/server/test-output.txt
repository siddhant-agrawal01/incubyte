
> server@1.0.0 test
> jest

FAIL src/__tests__/auth.test.ts
  ● Console

    console.error
      Login error: TypeError: Cannot read properties of undefined (reading 'findUnique')
          at login (/home/cipher/Music/incubyte/apps/server/src/controllers/authController.ts:54:36)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at /home/cipher/Music/incubyte/apps/server/src/middleware/validate.ts:10:7
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at Route.dispatch (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:119:3)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:284:15
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at Function.handle (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:175:3)
          at router (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:47:12)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at /home/cipher/Music/incubyte/node_modules/body-parser/lib/read.js:137:5
          at AsyncResource.runInAsyncScope (node:async_hooks:214:14)
          at invokeCallback (/home/cipher/Music/incubyte/node_modules/raw-body/index.js:238:16)
          at done (/home/cipher/Music/incubyte/node_modules/raw-body/index.js:227:7)
          at IncomingMessage.onEnd (/home/cipher/Music/incubyte/node_modules/raw-body/index.js:287:7)
          at IncomingMessage.emit (node:events:518:28)
          at endReadableNT (node:internal/streams/readable:1698:12)
          at processTicksAndRejections (node:internal/process/task_queues:90:21)

      83 |
      84 |   } catch (error) {
    > 85 |     console.error("Login error:", error);
         |             ^
      86 |
      87 |     sendError(res, ErrorCodes.INTERNAL_ERROR, "Login failed", 500);
      88 |   }

      at login (src/controllers/authController.ts:85:13)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at src/middleware/validate.ts:10:7
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (../../node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at ../../node_modules/express/lib/router/index.js:284:15
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Function.handle (../../node_modules/express/lib/router/index.js:175:3)
      at router (../../node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

    console.error
      Login error: TypeError: Cannot read properties of undefined (reading 'findUnique')
          at login (/home/cipher/Music/incubyte/apps/server/src/controllers/authController.ts:54:36)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at /home/cipher/Music/incubyte/apps/server/src/middleware/validate.ts:10:7
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at Route.dispatch (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:119:3)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:284:15
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at Function.handle (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:175:3)
          at router (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:47:12)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at /home/cipher/Music/incubyte/node_modules/body-parser/lib/read.js:137:5
          at AsyncResource.runInAsyncScope (node:async_hooks:214:14)
          at invokeCallback (/home/cipher/Music/incubyte/node_modules/raw-body/index.js:238:16)
          at done (/home/cipher/Music/incubyte/node_modules/raw-body/index.js:227:7)
          at IncomingMessage.onEnd (/home/cipher/Music/incubyte/node_modules/raw-body/index.js:287:7)
          at IncomingMessage.emit (node:events:518:28)
          at endReadableNT (node:internal/streams/readable:1698:12)
          at processTicksAndRejections (node:internal/process/task_queues:90:21)

      83 |
      84 |   } catch (error) {
    > 85 |     console.error("Login error:", error);
         |             ^
      86 |
      87 |     sendError(res, ErrorCodes.INTERNAL_ERROR, "Login failed", 500);
      88 |   }

      at login (src/controllers/authController.ts:85:13)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at src/middleware/validate.ts:10:7
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (../../node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at ../../node_modules/express/lib/router/index.js:284:15
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Function.handle (../../node_modules/express/lib/router/index.js:175:3)
      at router (../../node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

    console.error
      Login error: TypeError: Cannot read properties of undefined (reading 'findUnique')
          at login (/home/cipher/Music/incubyte/apps/server/src/controllers/authController.ts:54:36)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at /home/cipher/Music/incubyte/apps/server/src/middleware/validate.ts:10:7
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at Route.dispatch (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:119:3)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:284:15
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at Function.handle (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:175:3)
          at router (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:47:12)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at /home/cipher/Music/incubyte/node_modules/body-parser/lib/read.js:137:5
          at AsyncResource.runInAsyncScope (node:async_hooks:214:14)
          at invokeCallback (/home/cipher/Music/incubyte/node_modules/raw-body/index.js:238:16)
          at done (/home/cipher/Music/incubyte/node_modules/raw-body/index.js:227:7)
          at IncomingMessage.onEnd (/home/cipher/Music/incubyte/node_modules/raw-body/index.js:287:7)
          at IncomingMessage.emit (node:events:518:28)
          at endReadableNT (node:internal/streams/readable:1698:12)
          at processTicksAndRejections (node:internal/process/task_queues:90:21)

      83 |
      84 |   } catch (error) {
    > 85 |     console.error("Login error:", error);
         |             ^
      86 |
      87 |     sendError(res, ErrorCodes.INTERNAL_ERROR, "Login failed", 500);
      88 |   }

      at login (src/controllers/authController.ts:85:13)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at src/middleware/validate.ts:10:7
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (../../node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at ../../node_modules/express/lib/router/index.js:284:15
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Function.handle (../../node_modules/express/lib/router/index.js:175:3)
      at router (../../node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at ../../node_modules/body-parser/lib/read.js:137:5
      at invokeCallback (../../node_modules/raw-body/index.js:238:16)
      at done (../../node_modules/raw-body/index.js:227:7)
      at IncomingMessage.onEnd (../../node_modules/raw-body/index.js:287:7)

  ● Authentication API › POST /api/auth/register › should register a new user successfully

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 400

      63 |                 });
      64 |
    > 65 |             expect(response.status).toBe(201);
         |                                     ^
      66 |             expect(response.body.success).toBe(true);
      67 |             expect(response.body.data).toHaveProperty('token');
      68 |             expect(response.body.data).toHaveProperty('user');

      at Object.<anonymous> (src/__tests__/auth.test.ts:65:37)

  ● Authentication API › POST /api/auth/login › should login user with correct credentials

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      135 |                 });
      136 |
    > 137 |             expect(response.status).toBe(200);
          |                                     ^
      138 |             expect(response.body.success).toBe(true);
      139 |             expect(response.body.data).toHaveProperty('token');
      140 |             expect(response.body.data).toHaveProperty('user');

      at Object.<anonymous> (src/__tests__/auth.test.ts:137:37)

  ● Authentication API › POST /api/auth/login › should return 401 for incorrect password

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 500

      158 |                 });
      159 |
    > 160 |             expect(response.status).toBe(401);
          |                                     ^
      161 |             expect(response.body.success).toBe(false);
      162 |         });
      163 |

      at Object.<anonymous> (src/__tests__/auth.test.ts:160:37)

  ● Authentication API › POST /api/auth/login › should return 401 for non-existent user

    expect(received).toBe(expected) // Object.is equality

    Expected: 401
    Received: 500

      172 |                 });
      173 |
    > 174 |             expect(response.status).toBe(401);
          |                                     ^
      175 |             expect(response.body.success).toBe(false);
      176 |         });
      177 |     });

      at Object.<anonymous> (src/__tests__/auth.test.ts:174:37)

FAIL src/__tests__/sweets.test.ts
  ● Console

    console.error
      Get sweets error: TypeError: prisma_1.default.sweet.count is not a function
          at getSweets (/home/cipher/Music/incubyte/apps/server/src/controllers/sweetController.ts:43:20)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at /home/cipher/Music/incubyte/apps/server/src/middleware/validate.ts:24:7
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at authenticate (/home/cipher/Music/incubyte/apps/server/src/__tests__/sweets.test.ts:27:9)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at Route.dispatch (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:119:3)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:284:15
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at Function.handle (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:175:3)
          at router (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:47:12)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at jsonParser (/home/cipher/Music/incubyte/node_modules/body-parser/lib/types/json.js:113:7)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at expressInit (/home/cipher/Music/incubyte/node_modules/express/lib/middleware/init.js:40:5)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at query (/home/cipher/Music/incubyte/node_modules/express/lib/middleware/query.js:45:5)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at Function.handle (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:175:3)
          at Function.handle (/home/cipher/Music/incubyte/node_modules/express/lib/application.js:181:10)
          at Server.app (/home/cipher/Music/incubyte/node_modules/express/lib/express.js:39:9)
          at Server.emit (node:events:518:28)
          at parserOnIncoming (node:_http_server:1153:12)
          at HTTPParser.parserOnHeadersComplete (node:_http_common:117:17)

      54 |     });
      55 |   } catch (error) {
    > 56 |     console.error("Get sweets error:", error);
         |             ^
      57 |     sendError(res, ErrorCodes.INTERNAL_ERROR, "Failed to fetch sweets", 500);
      58 |   }
      59 | };

      at getSweets (src/controllers/sweetController.ts:56:13)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at src/middleware/validate.ts:24:7
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at authenticate (src/__tests__/sweets.test.ts:27:9)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (../../node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at ../../node_modules/express/lib/router/index.js:284:15
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Function.handle (../../node_modules/express/lib/router/index.js:175:3)
      at router (../../node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at jsonParser (../../node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at expressInit (../../node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at query (../../node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Function.handle (../../node_modules/express/lib/router/index.js:175:3)
      at Function.handle (../../node_modules/express/lib/application.js:181:10)
      at Server.app (../../node_modules/express/lib/express.js:39:9)

    console.error
      Get sweets error: TypeError: prisma_1.default.sweet.count is not a function
          at getSweets (/home/cipher/Music/incubyte/apps/server/src/controllers/sweetController.ts:43:20)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at /home/cipher/Music/incubyte/apps/server/src/middleware/validate.ts:24:7
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at authenticate (/home/cipher/Music/incubyte/apps/server/src/__tests__/sweets.test.ts:27:9)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:149:13)
          at Route.dispatch (/home/cipher/Music/incubyte/node_modules/express/lib/router/route.js:119:3)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:284:15
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at Function.handle (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:175:3)
          at router (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:47:12)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at jsonParser (/home/cipher/Music/incubyte/node_modules/body-parser/lib/types/json.js:113:7)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at expressInit (/home/cipher/Music/incubyte/node_modules/express/lib/middleware/init.js:40:5)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at query (/home/cipher/Music/incubyte/node_modules/express/lib/middleware/query.js:45:5)
          at Layer.handle [as handle_request] (/home/cipher/Music/incubyte/node_modules/express/lib/router/layer.js:95:5)
          at trim_prefix (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:328:13)
          at /home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:286:9
          at Function.process_params (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:346:12)
          at next (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:280:10)
          at Function.handle (/home/cipher/Music/incubyte/node_modules/express/lib/router/index.js:175:3)
          at Function.handle (/home/cipher/Music/incubyte/node_modules/express/lib/application.js:181:10)
          at Server.app (/home/cipher/Music/incubyte/node_modules/express/lib/express.js:39:9)
          at Server.emit (node:events:518:28)
          at parserOnIncoming (node:_http_server:1153:12)
          at HTTPParser.parserOnHeadersComplete (node:_http_common:117:17)

      54 |     });
      55 |   } catch (error) {
    > 56 |     console.error("Get sweets error:", error);
         |             ^
      57 |     sendError(res, ErrorCodes.INTERNAL_ERROR, "Failed to fetch sweets", 500);
      58 |   }
      59 | };

      at getSweets (src/controllers/sweetController.ts:56:13)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at src/middleware/validate.ts:24:7
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at authenticate (src/__tests__/sweets.test.ts:27:9)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at next (../../node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (../../node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at ../../node_modules/express/lib/router/index.js:284:15
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Function.handle (../../node_modules/express/lib/router/index.js:175:3)
      at router (../../node_modules/express/lib/router/index.js:47:12)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at jsonParser (../../node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at expressInit (../../node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at query (../../node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (../../node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (../../node_modules/express/lib/router/index.js:328:13)
      at ../../node_modules/express/lib/router/index.js:286:9
      at Function.process_params (../../node_modules/express/lib/router/index.js:346:12)
      at next (../../node_modules/express/lib/router/index.js:280:10)
      at Function.handle (../../node_modules/express/lib/router/index.js:175:3)
      at Function.handle (../../node_modules/express/lib/application.js:181:10)
      at Server.app (../../node_modules/express/lib/express.js:39:9)

    console.error
      Purchase error: Error: NOT_FOUND
          at /home/cipher/Music/incubyte/apps/server/src/controllers/sweetController.ts:179:15
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

      210 |     });
      211 |   } catch (error: any) {
    > 212 |     console.error("Purchase error:", error);
          |             ^
      213 |     if (error.message === "NOT_FOUND") {
      214 |       sendError(res, ErrorCodes.NOT_FOUND, "Sweet not found", 404);
      215 |     } else if (error.message === "OUT_OF_STOCK") {

      at purchaseSweet (src/controllers/sweetController.ts:212:13)

    console.error
      Purchase error: Error: OUT_OF_STOCK
          at /home/cipher/Music/incubyte/apps/server/src/controllers/sweetController.ts:183:15
          at processTicksAndRejections (node:internal/process/task_queues:105:5)

      210 |     });
      211 |   } catch (error: any) {
    > 212 |     console.error("Purchase error:", error);
          |             ^
      213 |     if (error.message === "NOT_FOUND") {
      214 |       sendError(res, ErrorCodes.NOT_FOUND, "Sweet not found", 404);
      215 |     } else if (error.message === "OUT_OF_STOCK") {

      at purchaseSweet (src/controllers/sweetController.ts:212:13)

  ● Sweets API › GET /api/sweets › should return list of sweets with pagination

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

      73 |                 .query({ page: 1, limit: 10 });
      74 |
    > 75 |             expect(response.status).toBe(200);
         |                                     ^
      76 |             expect(response.body.success).toBe(true);
      77 |             expect(response.body.data.sweets).toHaveLength(1);
      78 |             expect(response.body.data.sweets[0].name).toBe('Chocolate Truffle');

      at Object.<anonymous> (src/__tests__/sweets.test.ts:75:37)

  ● Sweets API › GET /api/sweets › should filter sweets by category

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 500

       96 |                 .query({ category: 'Chocolate' });
       97 |
    >  98 |             expect(response.status).toBe(200);
          |                                     ^
       99 |             expect(prisma.sweet.findMany).toHaveBeenCalledWith(
      100 |                 expect.objectContaining({
      101 |                     where: expect.objectContaining({ category: 'Chocolate' }),

      at Object.<anonymous> (src/__tests__/sweets.test.ts:98:37)

  ● Sweets API › POST /api/sweets/:id/purchase › should return 400 for insufficient stock

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 409

      177 |                 .send({ quantity: 1 });
      178 |
    > 179 |             expect(response.status).toBe(400);
          |                                     ^
      180 |             expect(response.body.success).toBe(false);
      181 |         });
      182 |     });

      at Object.<anonymous> (src/__tests__/sweets.test.ts:179:37)

  ● Sweets API › POST /api/sweets (Admin only) › should create a new sweet as admin

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 403

      214 |                 .send(newSweet);
      215 |
    > 216 |             expect(response.status).toBe(201);
          |                                     ^
      217 |             expect(response.body.success).toBe(true);
      218 |             expect(response.body.data.sweet.name).toBe('New Sweet');
      219 |         });

      at Object.<anonymous> (src/__tests__/sweets.test.ts:216:37)

  ● Sweets API › PUT /api/sweets/:id (Admin only) › should update a sweet as admin

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      244 |                 .send({ price: 300.00, quantity: 75 });
      245 |
    > 246 |             expect(response.status).toBe(200);
          |                                     ^
      247 |             expect(response.body.success).toBe(true);
      248 |         });
      249 |     });

      at Object.<anonymous> (src/__tests__/sweets.test.ts:246:37)

  ● Sweets API › DELETE /api/sweets/:id (Admin only) › should delete a sweet as admin

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      264 |                 .delete('/api/sweets/1');
      265 |
    > 266 |             expect(response.status).toBe(200);
          |                                     ^
      267 |             expect(response.body.success).toBe(true);
      268 |         });
      269 |

      at Object.<anonymous> (src/__tests__/sweets.test.ts:266:37)

  ● Sweets API › DELETE /api/sweets/:id (Admin only) › should return 404 when deleting non-existent sweet

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 403

      274 |                 .delete('/api/sweets/999');
      275 |
    > 276 |             expect(response.status).toBe(404);
          |                                     ^
      277 |             expect(response.body.success).toBe(false);
      278 |         });
      279 |     });

      at Object.<anonymous> (src/__tests__/sweets.test.ts:276:37)

Test Suites: 2 failed, 2 total
Tests:       11 failed, 5 passed, 16 total
Snapshots:   0 total
Time:        1.661 s
Ran all test suites.
npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /home/cipher/Music/incubyte/apps/server
npm error workspace server@1.0.0
npm error location /home/cipher/Music/incubyte/apps/server
npm error command failed
npm error command sh -c jest
